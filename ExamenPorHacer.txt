#include <stdio.h>
#include <unistd.h>
#include <stdlib.h>
#include <fcntl.h>
#include <sys/stat.h>
#include <sys/wait.h>
#include <math.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <time.h>

int main(void){

    printf("\nAlumno: Javier David Tejera Guerra - 2 DAM\n");

    pid_t pid1, pid2;
    int fd1[2], fd2[2];

    // Crear pipe1 entre P1 y P2
    if (pipe(fd1) == -1) {
        printf("\nError creando pipe1\n");
        return 1;
    }

    //Creamos el fork del pid 1 (Para el proceso padre P1 y proceso hijo P1)
    pid1 = fork();

    if (pid1 < 0){//Error en primer Fork();
        printf("\nHa ocurrido un error.");
        exit(1);
    }
    else if(pid1 == 0){//Proceso hijo de P1

        // Crear pipe1 entre P2 y P3
        if (pipe(fd2) == -1) {
            printf("\nError creando pipe1\n");
            return 1;
        }

        pid2 = fork();

        if (pid2 < 0){//Error en segundo fork();
            printf("\nHa ocurrido un error.");
            exit(1);

        }
        else if(pid2 == 0){//Proceso 3

            printf("\nSoy el proceso P3 - PID = %d - PPID = %d\n", getpid(), getppid());
            int datosATratrar[3];
            read(fd2[1], &datosATratrar, sizeof(datosATratrar));

            int pares = 0, impares = 1;
            for (int i = 0; i < sizeof(datosATratrar); i++){
                
                if (datosATratrar[i] % 2 == 0){ //Tratar datos pares
                    pares = pares + datosATratrar[i];
                }else{//Tratar datos impares
                    impares = impares * datosATratrar[i];
                }
            }
            
            //Definimos un array para reenviar los datos.
            int datosTratados[2];
            datosTratados[1] = pares;
            datosTratados[2] = impares;

            //Enviamos el array
            write(fd2[0], &datosATratrar, sizeof(datosATratrar));

            close(fd2[0]);//Cerramos la escritura
            close(fd2[1]);//Cerramos la lectura
            printf("0\nHa terminado el proceso P3");
            exit(0);
        }
        else{//Proceso 2

            printf("\nSoy el proceso P2 - PID = %d - PPID = %d\n", getpid(), getppid());

            //Creamos el fork del pid 1 (Para el proceso padre P1 y proceso hijo P1
            //Recibimos el valor de P1:
            close(fd1[0]);//Cerramos el extremo de escritura
            int cantidadNumeros = 3;
            read(fd1[1], &cantidadNumeros, sizeof(cantidadNumeros));
            close(fd1[0]);//Creamos el extremo de lectura.
            printf("\nHe recibido del proceso P1 esta cantidad de números: %d", cantidadNumeros);

            int datosATratar[cantidadNumeros];

            for (int i = 0; i < cantidadNumeros; i++){//Creamos un for que pida todos los números con los que trabajaremos
                scanf("%d", &datosATratar[i]);
            }
            
            write(fd2[0], &datosATratar, sizeof(datosATratar));
            read()

            wait(NULL);//Esperamos a que el proceso P3 termine
            printf("\nHa terminado el proceso P2");
            exit(0);
        }  
    }
    else{//Proceso padre de P1 --------------------------------------------------------------------------------------------------------
        printf("\nSoy el proceso P1 - PID = %d - PPID = %d\n", getpid(), getppid());
        printf("\nDame la cantidad de números que quieres enviar:");

        //Pedimos la cantidad de números y la escribimos en pantalla para verificar que se ha enviado correctamente.
        int cantidadNumeros;
        scanf("%d", &cantidadNumeros);
        printf("\nEnviando %d al proceso P2.", cantidadNumeros);
    
        close(fd1[0]);//Cerramos el extremo de lectura 
        write(fd1[0], &cantidadNumeros, sizeof(cantidadNumeros));
        close(fd1[0]);//Ceramos el extremos de escritura

        wait(NULL);//Esperamos que el proceso P2 termine
        printf("\nHa terminado el proceso P1");
    }

    return 0;
}
