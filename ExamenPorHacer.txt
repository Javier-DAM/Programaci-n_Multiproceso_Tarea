#include <stdio.h>
#include <unistd.h>
#include <stdlib.h>
#include <fcntl.h>
#include <sys/stat.h>
#include <sys/wait.h>
#include <math.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <time.h>

int main(void){

    printf("\nAlumno: Javier David Tejera Guerra - 2 DAM\n");

    pid_t pid1, pid2;
    int fd1[2], fd2[2];

    // Crear pipe1 entre P1 y P2
    if (pipe(fd1) == -1) {
        printf("\nError creando pipe1\n");
        return 1;
    }

    // Creamos el fork del pid 1 (Para el proceso padre P1 y proceso hijo P2)
    pid1 = fork();

    if (pid1 < 0){// Error en primer Fork()
        printf("\nHa ocurrido un error.");
        exit(1);
    }
    else if(pid1 == 0){// Proceso hijo P2

        // Crear pipe2 entre P2 y P3
        if (pipe(fd2) == -1) {
            printf("\nError creando pipe2\n");
            return 1;
        }

        pid2 = fork();

        if (pid2 < 0){// Error en segundo fork()
            printf("\nHa ocurrido un error.");
            exit(1);
        }
        else if(pid2 == 0){// Proceso P3
            
            int cantidadNumeros;
            read(fd2[0], &cantidadNumeros, sizeof(cantidadNumeros));
            
            int datosATratar[cantidadNumeros];
            read(fd2[0], datosATratar, sizeof(cantidadNumeros));

            printf("\nHe recibido estos números:");
            for (int i = 0; i < cantidadNumeros; i++){
                printf("\nNumero %d = %d", (i+1), datosATratar[i]);
            }

            int pares = 0, impares = 1;
            for (int i = 0; i < cantidadNumeros; i++){
                if (datosATratar[i] % 2 == 0){ // Tratar datos pares
                    pares = pares + datosATratar[i];
                } else { // Tratar datos impares
                    impares = impares * (int) datosATratar[i];
                }
            }
            
            // Definimos un array para reenviar los datos
            int datosTratados[2];
            datosTratados[0] = pares;
            datosTratados[1] = impares;

            // Enviamos el array
            write(fd2[1], datosTratados, sizeof(datosTratados));

            close(fd2[0]); // Cerramos la lectura
            close(fd2[1]); // Cerramos la escritura
            printf("\nHa terminado el proceso P3 - PID = %d - PPID = %d\n", getpid(), getppid());
            exit(0);
        }
        else{// Proceso P2

            // Recibimos el valor de P1:
            close(fd1[1]); // Cerramos el extremo de escritura del pipe1
            int cantidadNumeros;
            read(fd1[0], &cantidadNumeros, sizeof(cantidadNumeros));
            close(fd1[0]); // Cerramos el extremo de lectura del pipe1
            printf("\nHe recibido del proceso P1 esta cantidad de números: %d\n", cantidadNumeros);

            int datosATratar[cantidadNumeros];

            printf("Introduce %d números:\n", cantidadNumeros);
            for (int i = 0; i < cantidadNumeros; i++){ // Pedimos todos los números
                printf("Número %d: ", i+1);
                scanf("%d", &datosATratar[i]);
            }
            
            // Enviamos datos a P3
            close(fd2[0]); // Cerramos lectura del pipe2
            write(fd2[1], &cantidadNumeros, sizeof(cantidadNumeros));
            write(fd2[1], datosATratar, sizeof(cantidadNumeros));

            // Recibimos resultados de P3
            int resultados[2];
            read(fd2[0], resultados, sizeof(resultados));
            
            printf("\nResultados recibidos de P3:\n");
            printf("Suma de pares: %d\n", resultados[0]);
            printf("Producto de impares: %d\n", resultados[1]);

            close(fd2[1]); // Cerramos escritura del pipe2
            close(fd2[0]); // Cerramos lectura del pipe2
            
            wait(NULL); // Esperamos a que el proceso P3 termine
            printf("Ha terminado el proceso P2 - PID = %d - PPID = %d\n", getpid(), getppid());
            exit(0);
        }  
    }
    else{// Proceso padre P1
        printf("\nDame la cantidad de números que quieres enviar: ");

        // Pedimos la cantidad de números
        int cantidadNumeros;
        scanf("%d", &cantidadNumeros);
        printf("\nEnviando %d al proceso P2.\n", cantidadNumeros);
    
        close(fd1[0]); // Cerramos el extremo de lectura del pipe1
        write(fd1[1], &cantidadNumeros, sizeof(cantidadNumeros));
        close(fd1[1]); // Cerramos el extremo de escritura del pipe1

        wait(NULL); // Esperamos que el proceso P2 termine
        printf("Ha terminado el proceso P1 - PID = %d - PPID = %d\n", getpid(), getppid());
    }

    return 0;
}
